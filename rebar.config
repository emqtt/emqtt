%% -*- mode: erlang;erlang-indent-level: 4;indent-tabs-mode: nil -*-
%% ex: ts=4 sw=4 ft=erlang et

{require_min_otp_vsn, "R17"}.

{erl_opts, [warn_export_all,
            warn_unused_import,
%            warnings_as_errors,
            {i, "include"},
			{src_dirs, ["src"]},
            {parse_transform, lager_transform},
            debug_info]}.

{eunit_opts, [verbose]}.

{xref_checks, [undefined_function_calls]}.
{cover_enabled, true}.

{validate_app_modules, true}.

%% directory in '<base_dir>/<profile>/' where rebar plugins go
{plugins_dir, "_plugins"}.

%% directories where OTP applications for the project can be located
{project_app_dirs, [".", "plugins/*"]}.

{deps, [
	{gproc, ".*", {git, "git://github.com/uwiger/gproc.git", {branch, "master"}}},
	{lager, ".*", {git, "git://github.com/basho/lager.git", {branch, "master"}}},
	{esockd, "3.*", {git, "git://github.com/emqtt/esockd.git", {branch, "master"}}},
	{mochiweb, "4.*", {git, "git://github.com/emqtt/mochiweb.git", {branch, "master"}}}
]}.

{recursive_cmds, [ct, eunit, clean]}.


{relx, [{release, {emqttd, "0.1.0"},
         [
          kernel,
          stdlib,
          sasl,
          asn1,
          syntax_tools,
          ssl,
          crypto,
          {mnesia, load},
          eldap,
          xmerl,
          os_mon,
          inets,
          goldrush,
          compiler,
          lager,
          {gen_logger, load},
          gproc,
          esockd,
          mochiweb,
          emqttd]},

        {vm_args, "./rel/files/vm.args"},
        {dev_mode, true},
        {include_erts, false},
        {include_src, false},
        {extended_start_script, true},
        {generate_start_script, true},
        {include_nodetool, true},

        {overlay_vars, "rel/vars.config"},
        {overlay, [
                   {mkdir, "log/"},
                   {mkdir, "etc/"},
                   {mkdir, "etc/ssl/"},
                   {mkdir, "data/"},
                   {mkdir, "data/mnesia"},

                   {template, "rel/files/emqttd_ctl", "bin/emqttd_ctl"},
                   {template, "rel/files/emqttd_top", "bin/emqttd_top"},
                   {template, "rel/files/emqttd_run", "bin/emqttd_run"},

                    %% Copy config files
                   {copy, "rel/files/ssl/ssl.crt", "etc/ssl/ssl.crt"},
                   {copy, "rel/files/ssl/ssl.key", "etc/ssl/ssl.key"},
                   {template, "rel/files/emqttd.config.production", "etc/emqttd.config"},
                   {template, "rel/files/acl.config", "etc/acl.config"},
                   {template, "rel/files/rewrite.config", "etc/rewrite.config"},
                   {template, "rel/files/clients.config", "etc/clients.config"},
                   {template, "rel/files/vm.args", "etc/vm.args"}, 
                   {copy, "rel/files/loaded_plugins", "data/loaded_plugins"}
                  ]}
]}.

{profiles, [{prod, [
%                    {erl_opts, [no_debug_info, warnings_as_errors]},
                    {relx, [
                            {dev_mode, false},
                            {include_erts, true}
                           ]}
                   ]},
            {dev, [
                   {erl_opts, [debug_info]},
                   {relx, [{dev_mode, true},
                           {include_erts, false},
                           {system_libs, false}
%                           {overlay_vars, "rel/vars.config"},
%                           {overlay, [
%                                      {template, "rel/files/emqttd.config.development", "etc/app.config"}
%                                     ]}
                          ]}
                  ]},
            {'rhel-6', [
                        {relx, [
                                {include_erts, "/home/jfreitas/pl/scity/code/erlang/rhel-6.7/erlang/18.1"},
                                {system_libs, "/home/jfreitas/pl/scity/code/erlang/rhel-6.7/erlang/18.1"}
                               ]}
                       ]},
            {'centos-7', [
                          {relx, [
                                  {include_erts, "/home/jfreitas/pl/scity/code/erlang/centos7/erlang"},
                                  {system_libs, "/home/jfreitas/pl/scity/code/erlang/centos7/erlang"}
                                 ]}
                         ]},
            {'win', [
                     {relx, [
%                             {overlay, [
%                                        {template, "rel/files/emqttd.cmd", "bin/emqttd.cmd"},
%                                        {copy, "rel/files/start_erl.cmd", "bin/start_erl.cmd"}
%                                       ]}
                            ]}
                      ]}
          ]}.
